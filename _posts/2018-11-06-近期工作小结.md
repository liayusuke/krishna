---
layout: post
title:  "agent/server小记"
date:   2018-11-06 14:34:56 +0530
categories: jekyll update
icon: thumbs-o-up

---

到新公司后第一个相对还比较大的需求，终于不用再写lua啦，这里试了下golang，记录一下~~

## 背景

> 现有多维度，增量，带时效的数据需要在openresty做查询。之前的方案是nginx定时器拉取数据缓存到自身的lru中，但是数据量不能过大，否则会影响nginx性能。现在改为由单独的agent缓存全量数据，nginx通过ipc查询agent是否命中。



## 代理Server

> 消费kafka，提供统一的数据格式

方案之初并未考虑要一个代理server，直接由agent消费kafka顺带拉取全量数据即可，只是后来放弃了这个方案，主要原因有以下几点

1. agent随nginx部署，机器有上百台，如果agent直接消费kafka，那么每个agent都是kafka中一个单独`consumer group`，这样可能对kafka数据扇出，流量激增，broker压力也大

2. c++操作kafka的lib `librdkafka`据文档所说，消费端会与每个broker建立一个线程，导致线程数不可控，这样违背了agent限制到不超过一个核使用率的初衷。

3. 数据由一份全量数据（http接口）与增量数据（kafka）构成，这两类数据格式并不相同，以防后期频繁变更（因为c++操作json多少比较麻烦）所以希望有接口能提供统一的数据格式。


> 最后决定用golang实现代理Server，用来消费kafka，同时提供格式统一的http接口



边学边写，过程中遇到一点小问题

+ `logrus`导致`map`并发读写`panic`，网上搜了下，`logrus`的`hook`貌似会有这个问题，于是去掉`hook`。
+ golang里`struct/json`互转是简单，但是记得`struct`里字段要大写，不然`unmarshal`取不到值

## Agent

> To be continued...